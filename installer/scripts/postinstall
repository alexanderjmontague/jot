#!/bin/bash

# Prompt user for extension ID with instructions
EXTENSION_ID=$(osascript -e 'text returned of (display dialog "Enter your Chrome extension ID for Jot.
Jot Helper needs this to connect your local files to the extension.

To find it:
1. Open Chrome and go to chrome://extensions
2. Enable \"Developer mode\" (toggle in top right)
3. Find \"Jot\" and copy the ID
   (looks like: omicjbpmfoppjopnogokibbgmdopdlgl)

Paste your extension ID:" default answer "" buttons {"Cancel", "OK"} default button "OK")' 2>/dev/null)

# Check if user cancelled
if [ $? -ne 0 ] || [ -z "$EXTENSION_ID" ]; then
    osascript -e 'display alert "Installation Cancelled" message "Jot Helper was not installed. Please re-run the installer and enter your extension ID."'
    exit 1
fi

# Trim whitespace
EXTENSION_ID=$(echo "$EXTENSION_ID" | tr -d '[:space:]')

# Validate format (32 lowercase alphanumeric characters)
if [[ ! "$EXTENSION_ID" =~ ^[a-z]{32}$ ]]; then
    osascript -e 'display alert "Invalid Extension ID" message "The extension ID must be exactly 32 lowercase letters (a-z).

Please re-run the installer with a valid extension ID from chrome://extensions."'
    exit 1
fi

# Get the current user's home directory
USER_HOME="$HOME"
if [ -z "$USER_HOME" ] || [ "$USER_HOME" = "/" ]; then
    USER_HOME=$(eval echo ~$USER)
fi

# Install locations (all in user's home - no admin needed)
JOT_DIR="$USER_HOME/Library/Application Support/Jot"
CHROME_HOSTS_DIR="$USER_HOME/Library/Application Support/Google/Chrome/NativeMessagingHosts"
BINARY_PATH="$JOT_DIR/jot-host"

# Create directories
mkdir -p "$JOT_DIR"
mkdir -p "$CHROME_HOSTS_DIR"

# Copy binary
cp /tmp/jot-install/jot-host "$BINARY_PATH"
chmod 755 "$BINARY_PATH"

# Create manifest with user's extension ID
cat > "$CHROME_HOSTS_DIR/com.jot.host.json" << MANIFEST
{
  "name": "com.jot.host",
  "description": "Jot native helper for saving clips to Obsidian",
  "path": "$BINARY_PATH",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://${EXTENSION_ID}/"
  ]
}
MANIFEST

# Cleanup temp files
rm -rf /tmp/jot-install

# Success message
osascript -e 'display alert "Jot Helper Installed!" message "Installation complete. Return to the Jot extension and click \"I'\''ve installed it\" to continue."'

exit 0
