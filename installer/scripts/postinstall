#!/bin/bash

# Fixed extension ID (derived from the key in manifest.json)
# This ID is the same across all Chromium browsers
EXTENSION_ID="lgjhokmhniplbigjblidponoailcldhd"

# Get the actual logged-in user (not root, which runs the installer)
INSTALLING_USER=$(stat -f '%Su' /dev/console)
USER_HOME=$(eval echo ~$INSTALLING_USER)

# Install locations
JOT_DIR="$USER_HOME/Library/Application Support/Jot"
BINARY_PATH="$JOT_DIR/jot-host"

# Create Jot directory and copy binary
mkdir -p "$JOT_DIR"
cp /tmp/jot-install/jot-host "$BINARY_PATH"
chmod 755 "$BINARY_PATH"

# Create config directory and ensure correct ownership
mkdir -p "$USER_HOME/.jot"
chown -R "$INSTALLING_USER" "$USER_HOME/.jot"
chown -R "$INSTALLING_USER" "$JOT_DIR"

# Manifest content
MANIFEST_CONTENT=$(cat << MANIFEST
{
  "name": "com.jot.host",
  "description": "Jot native helper for saving clips to Obsidian",
  "path": "$BINARY_PATH",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://${EXTENSION_ID}/"
  ]
}
MANIFEST
)

# Install manifest for all Chromium browsers
BROWSER_DIRS=(
    "$USER_HOME/Library/Application Support/Google/Chrome/NativeMessagingHosts"
    "$USER_HOME/Library/Application Support/Google/Chrome Beta/NativeMessagingHosts"
    "$USER_HOME/Library/Application Support/Google/Chrome Canary/NativeMessagingHosts"
    "$USER_HOME/Library/Application Support/Microsoft Edge/NativeMessagingHosts"
    "$USER_HOME/Library/Application Support/BraveSoftware/Brave-Browser/NativeMessagingHosts"
    "$USER_HOME/Library/Application Support/Arc/User Data/NativeMessagingHosts"
    "$USER_HOME/Library/Application Support/Chromium/NativeMessagingHosts"
    "$USER_HOME/Library/Application Support/Vivaldi/NativeMessagingHosts"
    "$USER_HOME/Library/Application Support/Opera Software/Opera Stable/NativeMessagingHosts"
)

for MANIFEST_DIR in "${BROWSER_DIRS[@]}"; do
    PARENT_DIR="$(dirname "$MANIFEST_DIR")"
    if [ -d "$PARENT_DIR" ]; then
        mkdir -p "$MANIFEST_DIR"
        echo "$MANIFEST_CONTENT" > "$MANIFEST_DIR/com.jot.host.json"
    fi
done

# Cleanup temp files
rm -rf /tmp/jot-install

# Success message
osascript -e 'display alert "Jot Helper Installed!" message "Installation complete. Jot will now work in Chrome, Edge, Brave, Arc, and other Chromium browsers."'

exit 0
